<script>
    const code = new URLSearchParams(location.search).get('code');
    let clientData = null;     // global
    
    /** 1. Init TinyMCE leer ***************************************/
    tinymce.init({ selector:'#templateEditor', height:300,
      plugins:'preview code lists', toolbar:'undo redo | bold italic underline | numlist bullist | code preview'
    });
    tinymce.init({ selector:'#customEditor',  height:220,
      plugins:'code lists', toolbar:'undo redo | bold italic underline | numlist bullist | code'
    });
    
    /** 2. Danach Daten laden **************************************/
    fetch('https://optionai.optionai.at/webhook/admin/load-client', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ proposal_code: code })
    })
    .then(r=>r.json())
    .then(arr=>{
       clientData = Array.isArray(arr) ? arr[0] : arr;
       if(!clientData){ alert('Kein Datensatz gefunden'); return; }
    
       // Warten bis beide Editoren bereit sind
       tinymce.activeEditor ? fillEditors() : tinymce.on('AddEditor', fillEditors);
    });
    
    function fillEditors(){
       tinymce.get('templateEditor').setContent(clientData.template.HTML || '');
       tinymce.get('customEditor').setContent(clientData.client["Custom HTML"] || '');
       document.getElementById('statusSelect').value = clientData.client.Status || 'draft';
    }
    
    /** 3. Speichern ************************************************/
    document.getElementById('saveTemplateBtn').onclick = async ()=>{
      await fetch('https://optionai.optionai.at/webhook/admin/save-template',{
         method:'POST',
         headers:{'Content-Type':'application/json'},
         body: JSON.stringify({
           template_id: clientData.template.id,
           html: tinymce.get('templateEditor').getContent()
         })
      });
      showToast('Template gespeichert ✅');
    };
    
    document.getElementById('saveCustomBtn').onclick = async ()=>{
      await fetch('https://optionai.optionai.at/webhook/admin/save-proposal',{
         method:'POST',
         headers:{'Content-Type':'application/json'},
         body: JSON.stringify({
           proposal_code: clientData.client["Proposal Code"],
           custom_html: tinymce.get('customEditor').getContent(),
           status: document.getElementById('statusSelect').value
         })
      });
      showToast('Custom gespeichert ✅');
    };
    </script>
    