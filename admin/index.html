<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - AI Cold Outreach System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Admin Dashboard</h1>
                    <p class="text-gray-600 mt-1">AI Cold Outreach System - Client Management</p>
                </div>
                <button id="logoutBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md transition-colors">
                    Logout
                </button>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="statusMessage" class="hidden mb-6 p-4 rounded-md">
            <div id="statusText"></div>
        </div>

        <!-- Clients Table -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900">Client Übersicht</h2>
            </div>
            
            <div class="overflow-x-auto">
                <table id="clientsTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Öffnen</th>
                        </tr>
                    </thead>
                    <tbody id="clientsTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Table rows will be inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="px-6 py-12 text-center">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                <p class="mt-2 text-gray-600">Clients werden geladen...</p>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden px-6 py-12 text-center">
                <p class="text-gray-600">Keine Clients gefunden.</p>
            </div>
        </div>
    </div>

    <script>
        // Status message helper
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            const statusText = document.getElementById('statusText');
            
            // Remove existing classes
            statusDiv.className = 'mb-6 p-4 rounded-md';
            
            // Add type-specific classes
            switch(type) {
                case 'error':
                    statusDiv.classList.add('bg-red-50', 'text-red-700', 'border', 'border-red-200');
                    break;
                case 'success':
                    statusDiv.classList.add('bg-green-50', 'text-green-700', 'border', 'border-green-200');
                    break;
                default:
                    statusDiv.classList.add('bg-blue-50', 'text-blue-700', 'border', 'border-blue-200');
            }
            
            statusText.textContent = message;
            statusDiv.classList.remove('hidden');
        }

        function hideStatus() {
            document.getElementById('statusMessage').classList.add('hidden');
        }

        // Status badge helper
        function getStatusBadge(status) {
            const statusMap = {
                'draft': { class: 'bg-gray-100 text-gray-800', text: 'Draft' },
                'pending': { class: 'bg-yellow-100 text-yellow-800', text: 'Pending' },
                'approved': { class: 'bg-green-100 text-green-800', text: 'Approved' },
                'signed': { class: 'bg-blue-100 text-blue-800', text: 'Signed' }
            };
            
            const config = statusMap[status] || { class: 'bg-gray-100 text-gray-800', text: status };
            return `<span class="inline-flex px-2 text-xs font-semibold rounded-full ${config.class}">${config.text}</span>`;
        }

        // Load clients from API
        async function loadClients() {
            console.log('Loading clients...');
            
            try {
                // Check authentication
                const user = netlifyIdentity.currentUser();
                if (!user) {
                    window.location.href = '/login.html';
                    return;
                }

                // Check admin role
                const roles = user.app_metadata?.roles || [];
                if (!roles.includes('admin')) {
                    showStatus('Zugriff verweigert. Admin-Berechtigung erforderlich.', 'error');
                    return;
                }

                // Get JWT token
                const token = user.token.access_token;
                console.log('Using JWT token for API call');

                // Make API call
                const response = await fetch('https://optionai.optionai.at/webhook/admin/load-clients', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('API Response Status:', response.status);

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const clients = await response.json();
                console.log('Clients loaded:', clients);

                // Render clients table
                renderClientsTable(clients);
                
            } catch (error) {
                console.error('Error loading clients:', error);
                showStatus(`Fehler beim Laden der Clients: ${error.message}`, 'error');
                
                // Hide loading state
                document.getElementById('loadingState').classList.add('hidden');
            }
        }

        // Render clients table
        function renderClientsTable(clients) {
            const tableBody = document.getElementById('clientsTableBody');
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');

            // Hide loading state
            loadingState.classList.add('hidden');

            // Check if clients array exists and has data
            if (!Array.isArray(clients) || clients.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }

            // Clear existing rows
            tableBody.innerHTML = '';

            // Render each client
            clients.forEach(client => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                const proposalCode = client['Proposal Code'] || client.proposalCode || '-';
                const fullName = client['Full Name'] || client.fullName || '-';
                const status = client.status || 'draft';

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${escapeHtml(proposalCode)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${escapeHtml(fullName)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${getStatusBadge(status)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <a href="client.html?code=${encodeURIComponent(proposalCode)}" 
                           class="text-blue-600 hover:text-blue-900 font-medium">
                            Öffnen
                        </a>
                    </td>
                `;

                tableBody.appendChild(row);
            });

            console.log(`Rendered ${clients.length} clients in table`);
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Logout handler
        function handleLogout() {
            netlifyIdentity.logout();
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', function() {
            console.log('Admin dashboard initializing...');

            // Set up logout button
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Initialize Netlify Identity
            netlifyIdentity.on('init', function(user) {
                console.log('Netlify Identity initialized, user:', user);
                if (user) {
                    loadClients();
                } else {
                    window.location.href = '/login.html';
                }
            });

            netlifyIdentity.on('logout', function() {
                console.log('User logged out, redirecting...');
                window.location.href = '/';
            });

            // Initialize the widget
            netlifyIdentity.init();
        });
    </script>
</body>
</html>